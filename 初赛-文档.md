# 基于国产AI芯片的Rust内核组件开发赛

队伍名称：泉城把子肉

队伍成员：赵长收，周睿，柏乔森，杨金全，宋志勇

## **第一部分 项目概述**

基于 Rust 编程语言，完善 StarryOS 组件，并在基于 RK3588 开发板上移植启动，最终实现 Yolo-v8 模型的正常运行，实现流程分为以下四个阶段：

1. StarryOS AArch64 架构适配

2. 移植适配 RK3588 开发板，实现 StarryOS 启动

3. 添加电源驱动、时钟驱动、emmc 驱动、PCIe NPU 驱动、IOMMU

4. 适配 Yolo-v8 模型

## **第二**部分 硬件平台分析

### **2.1** **芯片/SoC特性分析**

RK3588 是一款集成多种高性能处理单元的应用处理器芯片，由 Rockchip（瑞芯微电子）设计，采用了 ARM 的架构，主要面向 ARM PC、边缘计算、个人移动互联网设备以及其他多媒体产品应用。

1. 型号选择：RK3588

2. 特性分析

   - 基本信息：

     - CPU 八核 64 位（4×Cortex-A76+4×Cortex-A55），主频高达 2.4GHz；

     - ARM Mali-G610 MP4四核GPU，支持 OpenGL ES3.2/OpenCL 2.2/Vulkan1.1, 450 GFLOPS；

     - NPU 算力高达6TOPS(INT8)，支持 INT4/INT8/INT16 混合运算
 
     - ISP 集成 48MP ISP，支持HDR和3DNR

     - 硬解码 8K@60fps H.265/VP9/AVS2、8K@30fps H.264 AVC/MVC、4K@60fps AV1、1080P@60fps MPEG-2/-1/VC-1/VP8

     - 硬编码 8K@30fps H.265/H.264

     - 内存 LPDDR4/LPDDR4x（4GB/8GB/16GB 可选）

     - 存储 QSPI NOr FLASH: 16MB/32MB; MicroSD 卡插槽: up to 128GB; eMMC闪存插座，可外接 16GB/32GB/64GB/128GB/256GB eMMC模块; 用于 NVMe SSD(PCle 3.0x4) 的 M.2 2280 插槽高达2.000 MB/S

   - 接口参数：

     - 以太网：2 × PCIe 2.5G LAN(RTL8125BG)

     - 视频:  2xHDMI2.1 输出，高达 8K@60FPS; 1xType-C(DP1.4A) 输出，高达 8K@30FPS; 1xHDMI 输入，高达 4K@60FPS; 1xMIPIDSl4Lane 输出，高达 4K@60HZ

     - 音频输出 1 × 3.5mm音频接口（支持MIC录音，美标 CTIA）

     - TP接口 1x6Pin FPC插座
 
     - USB 2 × USB3.0（限流: 1A；上层：USB3.0(1)，与5G复用；下层：USB3.0(2)）

     - 扩展口 40Pin双排插针，具有以下复用功能: UART、I2C、SPI、CAN、I2S、PDM、AUDDSM、SDIO、PWM、GPIO

     - PCle M.2 M-KEY Socket： M.2 connector E key (top) for connectivity with PCle 3.0 x 4 lanes 2280 SSD固态硬盘

     - PCle M.2 E-KEY Socket： M.2 connector E key (top) for connectivity with PCle 2.0x1/PCM/UART/USB2.0，支持2230 Wi-Fi6 /BT模块

3. AI 加速单元（NPU）

   内置 6TOPS NPU（INT4/INT8/INT16/FP16混合运算），支持端侧主流 3B 以下参数模型部署

   - 支持主流AI框架：TensorFlow、PyTorch、MXNet、Caffe等

   - 支持模型转换工具（如MemryXDFP框架），简化部署流程

### **2.2** **开发板/Platform 特性分析**

Orange Pi5 Plus 采用了瑞芯微 RK3588 八核 64 位处理器，有 4GB/8GB/16GB LPDDR4/4X 内存和 eMMC 闪存插座，可以外接 6GB/32GB/64GB/128GB/256GB eMMC 模块。OPi 5 Plus 支持 Orange Pi 官方研发的操作系统 Orange Pi OS，同时，支持 Android12、Debian11、Ubuntu22.04 等操作系统。

![Orange Pi5 Plus](./imgs/Orange%20Pi5%20Plus.png)

Orange Pi5 Plus 是一款基于瑞芯微 RK3588 处理器的高性能单板计算机，适用于嵌入式系统开发、AI应用、边缘计算等多种场景。该开发板集成了丰富的接口和强大的计算能力，能够满足各种复杂应用的需求。

Orange Pi 5Plus 具有丰富的接口，有2个 HDMI 输出端口,1 个输入 HDMI 端口，最高可解码 8K@60P 视频，两个 PCIe 扩展的 2.5G 以太网接口，配备一个支持安装 NVMe 固态硬盘的 M.2 M-Key 插槽，一个支持 Wi-Fi6/BT 模块的 M.2 E-Key 插槽。此外，Orange Pi 5 Plus 有 2 个 USB 3.0、2 个 USB 2.0、2 个 Type-C（其中一个为电源接口）。

1. 开发板商品名称 Orange Pi5 Plus

2. 采购地址：[淘宝](https://item.taobao.com/item.htm?spm=a312a.7700824.w4004-23020891405.3.49108ec15qSG0u&id=718906164843&pisk=ga4EoOwwp426CuMKxPgy3bR6_F3Kl4WXtzMSZ7VoOvDndzwzZbc2Kemnq5ciaA9Id0wSalPYUv1Rv2ZZUR2ZKeaSR72agJrBdwHBa8P-C8T7Ozr9zSF8R63592FKy4XfhZ6b9W3-DP3cLykMSXFMqHmlfVcJm9w1hZ_b_McKP5XbPe1RlXhorXmoZNfZMjJorDYnS1loNpDoK8fN_jh2EbDk-CbiGAvntUx3shcSGUvoEvfZjAhnE40uEVfZwXH4EJLZQDfgd3qZxIssvxVnQUY2MXnHTW-WzUSotDDmj58lfPlEYxV3ushp1br0uDecCHM30owqGJ_M8-P3m8q0INTEz5q0zV4GICM3D5zrRyf5-VV0bSiU8t8IeJHuLynDZhm3DJZmbP6eWxqg_7iaX_KIFohuemU5HeH3ZSUYcq7yS2ol4gJ-s-u3ykJk4Dct_x1N_oOu5s5uhqEM23nNXfkfMsKJ2DYs_x1a13K-bsGZh62d)

3. 所需配置：Orange Pi5 Plus（8G）主板 + 32G emmc 卡 + Type-C 5V4A 中规电源

4. 对应价格：900.9￥

## **第三部分 移植工作难点分析**

### **3.1 StarryOS** 内核当前支持情况

- StarryOS 目前支持的架构有 riscv64、loongarch64，rk3588 属于 aarch64 架构，当前 aarch64 没有完整支持，且只包含 EL1 内核部分功能，需要实现 aarch64 架构的用户态切换功能。

- StarryOS 最小模式启动，需要实现的驱动包括 UART、GICv3(rk3588)、emmc等，目前只包含了 UART 驱动，其他驱动需要开发。

- StarryOS 目前没有支持 NPU 的驱动，需要开发 rk3588 内置 NPU 的驱动。

- 内核可以运行 busybox，支持基本的文件系统操作，包含 ext4 等文件系统，需要移植 RKNN 等 NPU 用户态支持程序。

### **3.2** **外设驱动开发**计划

准备移植电源驱动、时钟驱动、EMMC 驱动、NPU 驱动、IOMMU。

开发经验：团队长期从事 Rust 系统开发，熟悉各类外设驱动开发，具备丰富的驱动开发经验。曾使用Rust开发过多种操作系统无关的外设驱动，如：

- 串口驱动：pl011、ns16550

- 定时器驱动：arm generic timer

- 中断控制器驱动：GICv2、GICv3

- 存储驱动：飞腾emmc\sd卡驱动、rk3568 emmc\sd卡驱动

- 网络驱动：e1000e、igb(i210)

- PCIe 驱动：x86 pcie

- USB 驱动: xhci、uvc 摄像头

基于以上经验，团队有信心完成 rk3588 上的外设驱动开发任务。

### **3.3** **AI** 加速单元开发计划

集成瑞芯微 RK3588 内置 NPU（神经网络处理单元）的算力调度接口，实现：

1. Rust 语言层与 NPU 的通信交互，支持模型加载、推理任务提交与结果回传；

2. 内核级任务调度机制优化，确保 CPU 与 NPU 的协同计算效率，降低任务切换开销。

在此项目中，我们的开发经验和以往的项目经历将带来以下优势：

1. Rust 编程语言经验：

   我们在多个项目中深度使用 Rust，尤其是在高并发、低延迟的系统开发中积累了大量经验。Rust 的内存安全性和并发性特性将极大提高与 NPU 的通信交互效率。Rust 在实现高性能任务调度和多线程处理时，相比传统的 C/C++，具有更强的安全性和更少的运行时错误。

2. 嵌入式系统开发经验：

   我们在嵌入式系统和边缘计算领域有丰富的开发经验，特别是在嵌入式硬件加速和 AI 推理任务的实现上。熟悉不同硬件平台和内存管理技巧，能有效应对有限资源环境下的优化需求。

3. 驱动开发与硬件接口经验：

   在过去的项目中，我们参与与硬件相关的底层驱动开发工作，涉及硬件加速模块（如 GPU、NPU）的驱动编写。

4. 多线程与并行计算优化经验：

   我们在多个项目中，设计和实现了基于 Rust 的并行计算框架，并通过精细的任务调度、负载均衡和线程同步优化，实现了高效的并行计算。在 AI 加速的背景下，我能够快速为项目开发出适合的任务调度机制，确保 CPU 和 NPU 资源的高效利用。

5. 内核调度与系统优化能力：

   我们在多核处理器系统下的内核级任务调度优化有丰富的经验。曾在多个嵌入式项目中，通过自定义调度算法、优化中断处理、降低上下文切换频率等手段，有效提升了任务执行效率。这些经验可以帮助我们在本项目中优化任务调度机制，减少任务切换的延迟，提升协同计算的效率。

6. 深度学习知识储备：

   团队成员有丰富的 pytorch、burn(rust) 等深度学习框架使用经验，熟悉 yolo-v8 模型的训练和部署，具备一定的模型优化能力。虽未接触过内核态的 NPU 驱动开发，但熟悉上层应用的使用方式，有助于了解驱动行为、设计驱动架构，有信心通过查阅资料和团队协作完成该任务。

## **第四部分 开发计划与里程碑**

### **4.1** **人员分工**

周睿：移植适配 rk3588 ，在 rk3588 开发板上启动 StarryOS

柏乔森：外设驱动开发，添加电源驱动、时钟驱动

杨金全：外设驱动开发，EMMC 驱动

宋志勇：外设驱动开发，添加 IOMMU 驱动

赵长收：支持 Yolo 的适配

### **4.2** **开发环境/工具**

- linux：Ubuntu 24.04

- rustup 1.28.2 (e4f3ad6f8 2025-04-28)

- rustc 1.91.0-nightly (425a9c0a0 2025-08-17)

- make：用于编译U-Boot和内核

- aarch64-linux-gnu：用于将Rust代码编译为ARM架构的二进制文件

- rust-objdump：分析和反汇编 Rust 编译后的二进制文件

- vscode：安装 `rust-analyzer` 插件，提供智能补全、错误检查、调试支持

- dtc：用于编译设备树

### 4.3 开发计划

#### 第一周（09.24 ~ 09.30）

了解 StarryOS 的源码的组织结构和组件设计以及 RK3588 芯片的基本情况，Orange Pi5 Plus 开发板的基本外设接口，调试开发环境等

- 【60%】熟悉 StarryOS 源码

- 【100%】搭建基本的开发环境

- 【100%】了解 RK3588 的 NPU 物理接口和寄存器地址

- 【100%】关键外设地址映射（如 UART、PM、CLK、EMMC）

- 【100%】基于 Orange Pi5 Plus 原有系统启动开发板，了解其运行情况，测试 rknn 等 ai 模块

#### 第二周（10.01 ~ 10.07）

开始尝试在 Orange Pi5 Plus 开发板上启动 StarryOS

- 【100%】CPU 启动及初始化

- 【100%】内存管理单元（MMU）配置与页表管理

- 【100%】基本外设（UART）的初始化与驱动

- 【50%】Aarch64 内核态与用户态切换机制

#### 第三周（10.08 ~ 10.14）

完善驱动程序，实现可加载文件系统，进入用户态命令行

- 中断控制器（GIC-500）驱动适配

- CLK 驱动适配

- 电源管理（PMU）驱动适配

- EMMC 驱动适配

- 完成 RK3588 内置 NPU 的寄存器配置与初始化

#### 第四周（10.15 ~ 10.21）

继续完善驱动程序

- IOMMU 驱动

- 完成 RK3588 内置 NPU 的基本功能

- Yolo 模型的适配

#### 第五周（10.22 ~ 10.31）

实现并测试应用层功能，准备相关文档

- Yolo 模型的适配及验证

- 完善优化代码，规范合理化，提高可读性

- 输出开发指导文档和技术报告

- 录制演示视频

## 第五部分 计划设计的 Rust 组件说明

### 5.1 内核相关组件

1. axplat-aarch64-dyn

   组件介绍：axplat-aarch64-dyn 是一个动态内核平台抽象层，旨在为不同硬件架构提供抽象接口。它支持平台的动态加载，根据提供对应平台的设备树，解析设备树的相关节点选择平台所需的支持，增强了系统的可移植性

   主要功能：
   - 动态获取内存布局，将当前内存初始化由写死配置文件的方式，转化为通过设备树（arm riscv）或 acpi 动态读取的方式。
   - 提供跨平台的硬件接口抽象，简化底层硬件操作。

   API：
   - init_early： 在 early 阶段为主核心初始化平台
   - init_early_secondary： 在 early 阶段为辅助核心初始化平台
   - init_later： 在 later 阶段为主核心初始化平台
   - init_later_secondary： 在 later 阶段为辅助核心初始化平台
   - write_bytes： 将给定字节写入控制台
   - read_bytes： 从控制台读取字节到给定的可变片
   - phys_ram_ranges： 返回平台上的所有物理内存（RAM）范围
   - reserved_phys_ram_ranges： 返回平台上所有保留的物理内存范围
   - mmio_ranges： 返回平台上的所有设备内存（MMIO）范围
   - phys_to_virt： 物理地址转换为虚拟地址
   - virt_to_phys： 虚拟地址转换为物理地址
   - cpu_boot： 用给定的初始堆栈引导给定的CPU内核（在物理地址中）
   - system_off： 关闭整个系统
   - current_ticks： 以硬件刻度返回当前时钟时间
   - ticks_to_nanos： 将硬件刻度转换为纳秒
   - nanos_to_ticks：将纳秒转换为硬件刻度
   - epochoffset_nanos：返回以纳秒为单位的历元偏移量（到单调时钟开始的壁时间偏移量）
   - set_oneshot_timer：设置一次计时器，计时器中断将在指定的单调时间截止日期（以纳秒为单位）触发

### **5.2** **驱动相关组件**

1. rk3588-power

   组件介绍：rk3588-power 是一个电源管理驱动，负责控制系统的电源管理策略，包括电源的开启、关闭、休眠和唤醒等功能。

   主要功能：电源状态管理，根据系统需求管理电源的开关。

   API：
   - power_on 开启系统电源。
   - power_off 关闭系统电源。

2. rk3588-clk

   组件介绍：rk3588-clk 提供精确的时间管理服务，包括时钟同步、时间延迟控制和定时任务调度等。

   主要功能：
   - 时钟同步：确保系统时间与硬件时钟同步。
   - 定时器：实现定时任务调度和时间延迟功能。
   - 时间获取：提供系统时间接口，支持获取当前的时间戳。

   API：
   - set_system_clk：设置系统时间
   - get_system_clk：获取当前系统时间

3. rk3588-emmc

   组件介绍：rk3588-emmc 是一个基于 RK3588 的 eMMC 存储驱动，用于管理 RK3588 内置的 eMMC 存储设备。

   主要功能：
   - 设备识别：识别并初始化连接的 eMMC 设备
   - 数据传输：提供高效的 eMMC 数据传输接口

   API：
   - init：初始化 eMMC 设备
   - read：从 eMMC 设备中读取数据
   - write：向 eMMC 设备写入数据
   - fmt：格式化内容

4. rk3588-pcie

   组件介绍：rk3588-pcie 是一个用于管理 PCIe 总线设备的驱动，支持与各种 PCIe 设备的交互，如网络适配器、存储设备等

   主要功能：
   - 设备识别：识别并初始化连接的 PCIe 设备
   - 数据传输：提供高效的 PCIe 数据传输接口
   - 错误处理：处理 PCIe 设备的错误和异常。

   API：
   - alloc_memory32：在低 4 GB 里分配 32 位地址
   - alloc_memory64：在 64 位空间里分配 64 位地址
   - read：用‘ offset ’在‘ address ’处执行PCI读取操作
   - write：用‘ offset ’在‘ address ’处执行PCI写入操作
   - fmt：格式化内容
   - read_bar：读取与某个 PCI 设备相关的 BAR 地址
   - address：获取 PCI 设备的地址信息
   - header_type：返回 PCI 设备的头部类型

5. rk3588-npu

   组件介绍：rk3588-npu 提供对 NPU 设备的支持

   主要功能：
   - 调用 NPU 运行 AI 模型。

   API：
   - initialize_npu_device：初始化 NPU 设备
   - send_data：向 NPU 设备发送数据
   - get_device_status：查询 NPU 设备的状态

### **5.3** **AI 应用相关组件**

## **第六部分 创新点与优势**

1. 使用动态获取内存布局，将当前内存初始化由写死配置文件的方式，转化为通过设备树（arm riscv）或 acpi 动态读取的方式，物理内存地址和大小由 axconfig 定义，均为 const，调整为动态后，所有依赖项都需要由 const 转为动态。物理内存地址动态后，程序入口地址和物理内存地址的偏移 PHYS_VIRT_OFFSET 也需要改为动态，并且 kernel code 与 mmio 的 offset 是不同的，需要引入 linux 类似的内存分区，不同类型的地址需要采用不同的映射方式。

2. 开发 `ostool` 工具，更加方便通过 U-Boot 在 rk3588 上启动 Starry，具体来说通过一次性配置 `.peroject.toml` 文件中的编译指令，内核名称等信息，执行 `ostool run uboot` 指令，自动将编译后的系统镜像通过串口发送到 rk3568 开发板上，而避免了每次手动烧录或者通过 tftp 传送的繁琐。

3. 团队成员在 arceos 以及 axvisor 项目中具有一定技术知识储备，在平台适配和驱动开发上积累过经验

## 第七部分 预期成果

本次参赛预期实现

- 在 rk3588 开发板上启动 StarryOS
- 并覆盖电源驱动、时钟驱动、NPU 驱动、PCIe NPU 驱动
- 支持 StarryOS 上运行 ZLM 应用，进行网络摄像头的推拉视频流

提交代码包括

- 适配 rk3588 的动态平台代码
- 电源驱动、时钟驱动、emmc 驱动、PCIe 驱动、NPU 驱动的实现代码
- 适配 Yolo 应用的代码

输出文档

- 所有代码仓库中的 README

- 实现本次参赛作品成果的总体说明文档，包括实现的功能说明，代码仓库链接，实现效果展示等
